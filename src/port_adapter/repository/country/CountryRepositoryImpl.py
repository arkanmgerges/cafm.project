"""
The file is generated by a scaffold script
@author: Arkan M. Gerges<arkan.m.gerges@gmail.com>
"""

import os

from sqlalchemy import create_engine
from sqlalchemy.sql.expression import and_

from src.application.lifecycle.ApplicationServiceLifeCycle import ApplicationServiceLifeCycle
from src.domain_model.country.Country import Country
from src.domain_model.country.CountryRepository import CountryRepository
from src.domain_model.country.state.State import State
from src.domain_model.resource.exception.CityDoesNotExistException import CityDoesNotExistException
from src.domain_model.resource.exception.CountryDoesNotExistException import CountryDoesNotExistException
from src.port_adapter.repository.db_model.City import City as DbCity
from src.port_adapter.repository.db_model.Country import Country as DbCountry
from src.resource.logging.decorator import debugLogger
from src.resource.logging.logger import logger


class CountryRepositoryImpl(CountryRepository):
    @debugLogger
    def countryById(self, id: int) -> Country:
        dbSession = ApplicationServiceLifeCycle.dbContext()
        dbObject = dbSession.query(DbCountry).filter_by(geoNameId=id).first()
        if dbObject is None:
            raise CountryDoesNotExistException(f"id = {id}")
        return Country.createFrom(id=dbObject.geoNameId, name=dbObject.countryName)


    @debugLogger
    def stateByCountryIdAndStateId(self, countryId: int, stateId: str) -> State:
        dbSession = ApplicationServiceLifeCycle.dbContext()
        dbCountry = dbSession.query(DbCountry).filter_by(geoNameId=countryId).first()
        if dbCountry is None:
            raise CountryDoesNotExistException(f"id = {id}")
        countryIsoCode = dbCountry.countryIsoCode
        dbCity = dbSession.query(DbCity).filter(
            and_(DbCity.countryIsoCode == countryIsoCode, DbCity.subdivisionOneIsoCode == stateId)
        )
        if dbCity is None:
            raise CityDoesNotExistException(f"id = {id}")
        return State.createFrom(id=stateId, name=dbCity.subdivisionOneIsoName)

    def _updateDbObjectByObj(self, dbObject: DbCountry, obj: Country):
        dbObject.name = obj.name() if obj.name() is not None else dbObject.name
        return dbObject

    def _createDbObjectByObj(self, obj: Country):
        return DbCountry(id=obj.id(), name=obj.name())
